# Лабораторная работа №5 — Автоматизация CI/CD с Jenkins, Ansible и Docker

## Описание проекта

Данная лабораторная работа направлена на создание автоматизированного конвейера (pipeline) для сборки, тестирования, конфигурации и деплоя PHP-проекта с использованием:

* **Jenkins** — автоматизация процессов CI/CD
* **SSH Agent** — выполнение команд и сборки
* **Ansible Agent** — конфигурация тестового сервера
* **Test Server** — сервер, имитирующий production-среду
* **Docker Compose** — запуск всех сервисов в виде контейнеров

В этой работе создаются контейнеры Jenkins, SSH-агента, Ansible-агента и тестового сервера, а также Ansible playbook и набор Jenkins pipeline-ов.

---

# Структура проекта

```
lab05/
│
├── compose.yaml
├── Dockerfile.ssh_agent
├── Dockerfile.ansible_agent
├── Dockerfile.test_server
│
├── ansible/
│   ├── hosts.ini
│   └── setup_test_server.yml
│
└── pipelines/
    ├── php_build_and_test_pipeline.groovy
    ├── ansible_setup_pipeline.groovy
    └── php_deploy_pipeline.groovy
```

---

# 1. Настройка Jenkins Controller

(**Review из IW04**)

1. Создан сервис `jenkins-controller` в `compose.yaml`.
2. Контейнер запускается через Docker Compose.
3. Первичная настройка Jenkins выполнена через UI.
4. Установлены плагины:

   * Docker
   * Docker Pipeline
   * GitHub Integration
   * SSH Agent

Jenkins используется как центральный оркестратор всех операций.

---

# 2. Настройка SSH Agent

(**Review из IW04**)

1. Создан файл `Dockerfile.ssh_agent`.
2. Установлены необходимые пакеты:

   * php-cli
   * git
   * ssh
   * composer
3. Созданы SSH-ключи для интеграции Jenkins → SSH Agent:

   ```
   ssh-keygen -t ed25519 -f secrets/jenkins-to-ssh-agent
   ```
4. Публичный ключ добавлен в `authorized_keys` SSH-агента.
5. В Jenkins настроен credential для приватного ключа.
6. Добавлен сервис `ssh-agent` в `compose.yaml`.

SSH-агент выполняет сборку и юнит-тесты PHP-проекта.

---

# 3. Создание Ansible Agent

1. Создан `Dockerfile.ansible_agent` на базе Ubuntu.
2. Установлены:

   * Ansible
   * Python
   * Git
   * openjdk-11-jdk-headless (для Jenkins remoting)
   * SSH
3. Созданы ключи:

   * Jenkins → Ansible Agent
   * Ansible Agent → Test Server
4. Настроены SSH-ключи в контейнере:

   * `authorized_keys`
   * `id_rsa`

Сервис `ansible-agent` добавлен в `compose.yaml`.
Он принимает команды Jenkins и выполняет playbook-и.

---

# 4. Создание Test Server

1. Создан `Dockerfile.test_server` на базе Ubuntu.
2. Установлены:

   * openssh-server
   * Apache2
   * PHP + модули
3. Создан пользователь:

   ```
   useradd -m ansible
   ```
4. Разрешён доступ по SSH ключам.
5. Настроен `sudo` без пароля:

   ```
   ansible ALL=(ALL) NOPASSWD:ALL
   ```

Этот сервер выступает как тестовый environment, куда Ansible будет разворачивать проект.

---

# 5. Ansible Playbook для конфигурации тестового сервера

Создана папка `ansible`.

### Файл `hosts.ini`

```
[test-server]
test-server ansible_host=172.18.0.4 ansible_user=ansible ansible_ssh_private_key_file=~/.ssh/id_rsa
```

### Файл `setup_test_server.yml`

Playbook выполняет:

### 1. Установку Apache2

### 2. Установку PHP и расширений

### 3. Создание виртуального хоста Apache

### 4. Копирование PHP-проекта (если требуется)

### 5. Перезапуск Apache

Ansible обеспечивает полную автоматизацию конфигурации сервера.

---

# 6. Pipeline для сборки и тестирования PHP-проекта

Создан файл `pipelines/php_build_and_test_pipeline.groovy`.

Stages:

1. **Clone repository**
2. **Install dependencies (Composer)**
3. **Run PHPUnit tests**
4. **Publish JUnit test results**

Выполняется через SSH Agent.

---

# 7. Pipeline для настройки тестового сервера (Ansible)

Создан файл `pipelines/ansible_setup_pipeline.groovy`.

Stages:

1. **Clone repo with playbook**
2. **Run Ansible playbook**

   ```
   ansible-playbook -i hosts.ini setup_test_server.yml
   ```

Этим pipeline Jenkins вызывает конфигурацию сервера.

---

# 8. Pipeline для деплоя PHP-проекта

Создан `pipelines/php_deploy_pipeline.groovy`.

Stages:

1. **Clone PHP repo**
2. **Copy project files to test server**
   через SCP или Ansible `copy`
3. **Configure Apache/PHP if needed**
4. **Reload Apache**

Деплой также может выполняться через Ansible.

---

# 9. Тестирование деплоя

После выполнения pipelines:

* открываем в браузере:

  ```
  http://<ip_test_server>
  ```
* проверяем, что сайт работает
* убеждаемся, что PHP исполняется корректно

---

# Ответы на вопросы

---

## 1. **Преимущества использования Ansible для конфигурации сервера**

Безагентная архитектура (требуется только SSH)
Простота написания playbook (YAML)
Удобное переиспользование ролей
Идемпотентность (выполнение повторных задач не ломает систему)
Масштабируемость — легко управлять десятками серверов
Отлично интегрируется с Jenkins

---

## 2. **Какие ещё Ansible модули используются для конфигурации?**

Некоторые из самых популярных:

* `apt` — установка пакетов
* `service` — управление службами
* `copy` — копирование файлов
* `template` — шаблоны Jinja
* `user` — пользователи
* `file` — директории и права
* `lineinfile` — правка конфигов
* `git` — клонирование репозиториев
* `docker_container`, `docker_image` — работа с Docker
* `systemd` — работа с systemd

---

## 3. **С какими проблемами я столкнулся при создании playbook и как решил?**

### Проблема: "Permission denied (publickey)"

**Решение:**
– проверка путей ключей
– корректные права `chmod 600` на key
– размещение public key в `authorized_keys`

---

### Проблема: Ansible не видит файл конфигурации Apache

**Решение:**
– создать файл вручную
– указать правильный путь или удалить ненужную задачу

---

### Проблема: отсутствие директории `/run/sshd`

**Решение:**
Добавить в Dockerfile:

```
RUN mkdir /run/sshd
```

---

### Проблема: sudo: no tty

**Решение:**
Добавить:

```
ansible ALL=(ALL) NOPASSWD:ALL
```

---

# Итог

В результате лабораторной работы создан полностью автоматизированный CI/CD процесс:

* сборка и тестирование PHP-проекта
* настройка тестового сервера
* автоматический деплой
* выполнение всех процессов через Jenkins и Docker

